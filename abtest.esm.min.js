var _={extend:function(t){var e=Array.prototype.slice;return _.each(e.call(arguments,1),function(e){for(var a in e)void 0!==e[a]&&(t[a]=e[a])}),t},each:function(t,e,a){var r=Array.prototype.forEach,i={};if(null==t)return!1;if(r&&t.forEach===r)t.forEach(e,a);else if(t.length===+t.length){for(var n=0,s=t.length;n<s;n++)if(n in t&&e.call(a,t[n],n,t)===i)return!1}else for(var o in t)if(hasOwnProperty.call(t,o)&&e.call(a,t[o],o,t)===i)return!1},filter:function(t,e,a){var r=Object.prototype.hasOwnProperty;if(t.filter)return t.filter(e);for(var i=[],n=0;n<t.length;n++)if(r.call(t,n)){var s=t[n];e.call(a,s,n,t)&&i.push(s)}return i},isObject:function(t){return null!=t&&"[object Object]"==Object.prototype.toString.call(t)},isArray:Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)},isString:function(t){return"[object String]"==Object.prototype.toString.call(t)},isDate:function(t){return"[object Date]"==Object.prototype.toString.call(t)},isBoolean:function(t){return"[object Boolean]"==Object.prototype.toString.call(t)},isNumber:function(t){return"[object Number]"==Object.prototype.toString.call(t)&&/[\d\.]+/.test(String(t))},isFunction:function(t){if(!t)return!1;try{return/^\s*\bfunction\b/.test(t)}catch(t){return!1}},getURLSearchParams:function(t){for(var e=function(t){return decodeURIComponent(t)},a={},r=(t||"").split("&"),i=0;i<r.length;i++){var n=r[i].indexOf("=");if(-1!==n){var s=r[i].substring(0,n),o=r[i].substring(n+1);s=e(s),o=e(o),a[s]=o}}return a},log:function(){if("object"==typeof console&&console.log){_.isString(arguments[0])&&(arguments[0]="sensorsabtest————"+arguments[0]);try{return console.log.apply(console,arguments)}catch(t){console.log("sensorsabtest————",arguments[0])}}}};function getStorageSync(t){var e="";try{e=wx.getStorageSync(t)}catch(t){sa.log("\u83b7\u53d6 storage \u5931\u8d25\uff01")}return _.isJSONString(e)&&(e=JSON.parse(e)),e}function setStorageSync(t,e){var a;try{a=JSON.stringify(e)}catch(t){_.log("\u5e8f\u5217\u5316\u7f13\u5b58\u5bf9\u8c61\u5931\u8d25\uff01")}try{wx.setStorageSync(t,a)}catch(t){_.log("set Storage fail again --",t)}}function mixinFetch(t){t.fetchTest=function(){var e=0,a=!1,r=t.creatRequestData();function i(e){_.log("\u62c9\u53d6\u5b9e\u9a8c\u7ed3\u679c\u6210\u529f: ",e),a=!0,t.updateData(e.results),t.state.fetchInterval&&clearTimeout(t.state.fetchInterval),t.state.fetchInterval=setTimeout(function(){request({url:t.para.url,method:"POST",data:JSON.stringify(r),timeout:t.para.timeout_milliseconds,suc:i,fail:n})},t.para.update_interval)}function n(s){return _.log("\u62c9\u53d6\u5b9e\u9a8c\u7ed3\u679c\u5931\u8d25: ",s),e++,!a&&e<t.para.retry_times&&setTimeout(function(){request({url:t.para.url,method:"POST",data:JSON.stringify(r),timeout:t.para.timeout_milliseconds,suc:i,fail:n})},3e3),!1}request({url:t.para.url,method:"POST",data:JSON.stringify(r),timeout:t.para.timeout_milliseconds,suc:i,fail:n})},t.updateData=function(e){t.resolveData(e),setStorageSync(t.info.storage_key,t.state.test_list),_.log("\u66f4\u65b0\u8bd5\u9a8c\u6570\u636e")},t.resolveData=function(e){if(!_.isArray(e))return _.log("\u89e3\u6790——\u6570\u636e\u683c\u5f0f\u9519\u8bef",e),!1;t.state.test_list={},_.each(e,function(e){_.isObject(e)&&e.variables&&_.isArray(e.variables)&&_.each(e.variables,function(a){_.isObject(a)&&!t.state.test_list[a.name]&&(t.state.test_list[a.name]={abtest_experiment_id:e.abtest_experiment_id,abtest_experiment_group_id:e.abtest_experiment_group_id,is_control_group:e.is_control_group,is_white_list:e.is_white_list,config:getRelativeValue(a.value,a.type)})})})},t.creatRequestData=function(e){var a=t._sa.store.getUnionId(),r={anonymous_id:a.anonymous_id,platform:t.info.platform,abtest_lib_version:t.info.lib_version,properties:{$is_first_day:t._sa._.getIsFirstDay(),$latest_scene:t.info.scene}};return a.login_id&&(r.login_id=a.login_id),t._sa._.info.currentProps.$latest_scene&&(r.properties.$latest_scene=t._sa._.info.currentProps.$latest_scene),r.properties=_.extend({},r.properties,t.props),_.isObject(e)&&_.isObject(e.properties)&&(r.properties=_.extend({},r.properties,e.properties)),r}}function getRelativeValue(t,e){var a={},r={INTEGER:function(t){var e=parseFloat(t);isNaN(e)?_.log("\u539f\u59cb\u6570\u636e INTEGER \u7c7b\u578b\u89e3\u6790\u5f02\u5e38",t):(a.value=e,a.type="Number")},STRING:function(t){_.isString(t)?(a.value=t,a.type="String"):_.log("\u539f\u59cb\u6570\u636e STRING \u7c7b\u578b\u89e3\u6790\u5f02\u5e38",t)},JSON:function(t){if(_.isJSONString(t)){var e=JSON.parse(t);_.isObject(e)?(a.value=e,a.type="Object"):_.log("\u539f\u59cb\u6570\u636e JSON \u7c7b\u578b\u89e3\u6790\u5f02\u5e38",t)}},BOOLEAN:function(t){"true"===t?(a.value=!0,a.type="Boolean"):"false"===t?(a.value=!1,a.type="Boolean"):_.log("\u539f\u59cb\u6570\u636e BOOLEAN \u7c7b\u578b\u89e3\u6790\u5f02\u5e38",t)}};try{r[e]?r[e](t):_.log("\u8bd5\u9a8c\u6570\u636e\u7c7b\u578b\u89e3\u6790\u5931\u8d25",e,t)}catch(a){_.log(a,t,e)}return a}function request(t){var e=t.url,a="GET",r=null;t.method&&(a=t.method),t.data&&(r=t.data),wx.request({url:e,method:a,data:r,timeout:t.timeout,success:function(e){t.suc(e.data)},fail:function(e){t.fail(e)}})}_.isJSONString=function(t){try{JSON.parse(t)}catch(t){return!1}return!0},_.getQueryParam=function(t,e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]"),t=_.decodeURIComponent(t);var a=new RegExp("[\\?&]"+e+"=([^&#]*)").exec(t);return null===a||a&&"string"!=typeof a[1]&&a[1].length?"":_.decodeURIComponent(a[1])},_.decodeURIComponent=function(t){var e=t;try{e=decodeURIComponent(t)}catch(a){e=t}return e},_.getAppId=function(){var t;if(wx.getAccountInfoSync&&(t=wx.getAccountInfoSync()),_.isObject(t)&&_.isObject(t.miniProgram))return t.miniProgram.appId},_.formatSystem=function(t){var e=t.toLowerCase();return"ios"===e?"iOS":"android"===e?"Android":t},_.getSystemInfo=function(t){try{const e=wx.getSystemInfoSync();t.props.$manufacturer=e.brand,t.props.$model=e.model,t.props.$os=_.formatSystem(e.platform),t.props.$os_version=e.system.indexOf(" ")>-1?e.system.split(" ")[1]:e.system}catch(t){_.log("\u83b7\u53d6\u7cfb\u7edf\u4fe1\u606f\u5931\u8d25\uff01")}},_.validTimeout=function(t){return t.timeout_milliseconds&&_.isNumber(t.timeout_milliseconds)||(t.timeout_milliseconds=3e3),t.timeout_milliseconds<200&&(t.timeout_milliseconds=200),t},_.indexOf=function(t,e){var a=t.indexOf;if(a)return a.call(t,e);for(var r=0;r<t.length;r++)if(e===t[r])return r;return-1};var VALUE_TYPE_LIST=["Number","String","Object","Boolean"],verifyStore={valueType:function(t,e){switch(e){case"Number":if(_.isNumber(t))return!0;break;case"String":if(_.isString(t))return!0;break;case"Object":if(_.isObject(t))return!0;break;case"Boolean":if(!0===t||!1===t)return!0;break;default:return!1}return!1},para:function(t,e,a){var r=!0;return _.each(a,function(a,i){switch(a){case"param_name":e.param_name&&_.isString(e.param_name)&&e.param_name.length>0||(_.log(t+"\u65b9\u6cd5\u8c03\u7528\u5931\u8d25\uff0cparam_name\u53c2\u6570\u672a\u6b63\u786e\u914d\u7f6e\uff01param_name:",e.param_name),r=!1);break;case"value_type":_.isString(e.value_type)&&-1!==_.indexOf(VALUE_TYPE_LIST,e.value_type)||(_.log(t+"\u65b9\u6cd5\u8c03\u7528\u5931\u8d25\uff0cvalue_type\u914d\u7f6e\u9519\u8bef",e.value_type),r=!1);break;case"default_value":void 0===e.default_value?(_.log(t+"\u65b9\u6cd5\u8c03\u7528\u5931\u8d25\uff0cdefault_value\u53c2\u6570\u672a\u914d\u7f6e"),r=!1):verifyStore.valueType(e.default_value,e.value_type)||(_.log(t+"\u65b9\u6cd5\u8c03\u7528\u5931\u8d25\uff0cdefault_value\u7c7b\u578b\u5fc5\u987b\u4e0evalue_type\u4e00\u81f4\uff01",e.default_value,e.value_type),r=!1);break;case"callback":_.isFunction(e.callback)||(_.log(t+"\u65b9\u6cd5\u8c03\u7528\u5931\u8d25\uff0ccallback\u53c2\u6570\u672a\u6b63\u786e\u914d\u7f6e"),r=!1)}}),r}};function initAPI(t){t.setPara=function(e){if(!_.isString(e.url)||"http"!==e.url.slice(0,4))return _.log("A/B Testing SDK \u521d\u59cb\u5316\u5931\u8d25\uff0c\u8bf7\u4f7f\u7528\u6b63\u786e\u7684 URL\uff01"),!1;t.para.url=e.url;var a=_.getQueryParam(e.url,"project-key");return a?(t.para.project_key=a,_.isNumber(e.timeout_milliseconds)&&(e.timeout_milliseconds<200?t.para.timeout_milliseconds=200:t.para.timeout_milliseconds=e.timeout_milliseconds),_.isNumber(e.update_interval)&&(t.para.update_interval=e.update_interval),!0):(_.log("A/B Testing SDK \u521d\u59cb\u5316\u5931\u8d25\uff0c\u8bf7\u4f7f\u7528\u6b63\u786e\u7684 URL\uff08\u5fc5\u987b\u5305\u542b project-key\uff09\uff01"),!1)},t.asyncFetchABTest=function(e){return _.isObject(e)?!!verifyStore.para("asyncFetchABTest",e,["param_name","value_type","default_value","callback"])&&(_.validTimeout(e),void t.asyncFetch(e)):(_.log("asyncFetchABTest\u8c03\u7528\u5931\u8d25\uff0c\u53c2\u6570\u672a\u6b63\u786e\u914d\u7f6e"),!1)},t.fastFetchABTest=function(e){if(!_.isObject(e))return _.log("fastFetchABTest \u8c03\u7528\u5931\u8d25\uff0c\u53c2\u6570\u672a\u6b63\u786e\u914d\u7f6e"),!1;if(!verifyStore.para("fastFetchABTest",e,["param_name","value_type","default_value","callback"]))return!1;_.validTimeout(e);var a=t.searchLocalExp(e.param_name);if(_.isObject(a)){var r=t.getExpResult(e,a);e.callback(r)}else _.log("fastFetchABTest \u7f13\u5b58\u4e2d\u672a\u8bfb\u53d6\u5230\u6570\u636e\uff0c\u53d1\u8d77\u8bf7\u6c42"),t.asyncFetch(e)},t.fetchCacheABTest=function(e){if(_.isObject(e))return!!verifyStore.para("fetchCacheABTest",e,["param_name","value_type","default_value"])&&t.getExpResult(e);_.log("fetchCacheABTest\u8c03\u7528\u5931\u8d25\uff0c\u53c2\u6570\u672a\u6b63\u786e\u914d\u7f6e")},t.asyncFetch=function(e){t.getResultFromServer({para:e,suc:function(a){if(_.isObject(a)&&"SUCCESS"===a.status){_.log("\u83b7\u53d6\u5230\u670d\u52a1\u7aef\u5b9e\u9a8c\u7ed3\u679c\u6570\u636e: ",a),t.updateData(a.results);var r=t.getExpResult(e);e.callback(r)}else e.callback(e.default_value)},fail:function(t){_.log("\u83b7\u53d6\u670d\u52a1\u7aef\u6570\u636e\u5931\u8d25: ",t),e.callback(e.default_value)}})},t.searchLocalExp=function(e){return!!t.state.test_list[e]&&t.state.test_list[e]},t.getExpResult=function(e,a){var r=e.default_value,i=a||t.searchLocalExp(e.param_name);return _.isObject(i)?_.isObject(i.config)&&(i.config.type===e.value_type?(r=i.config.value,t.trackTestTrigger(i)):_.log("\u8bd5\u9a8c\u7ed3\u679c\u7c7b\u578b\u4e0e\u671f\u671b\u7c7b\u578b\u4e0d\u4e00\u81f4\uff0cparam_name\uff1a"+e.param_name+"\uff0c\u5f53\u524d\u8fd4\u56de\u7c7b\u578b\u4e3a\uff1a"+i.config.type+"\uff0c\u671f\u671b\u7c7b\u578b\u4e3a\uff1a"+e.value_type)):_.log("\u672c\u5730\u672a\u67e5\u8be2\u5230\u8bd5\u9a8c\u6570\u636e\uff0c\u8bd5\u9a8c\u53c2\u6570\u540d\u79f0\uff1a"+e.param_name),r},t.getResultFromServer=function(e){var a=(e=_.isObject(e)?e:{}).para||{},r=e.suc,i=e.fail,n=t.creatRequestData(a);request({url:t.para.url,method:"POST",data:JSON.stringify(n),contentType:"application/json",timeout:a.timeout_milliseconds||t.para.timeout_milliseconds,suc:r,fail:i}),_.log("\u5411\u670d\u52a1\u7aef\u53d1\u8d77\u8bd5\u9a8c\u8bf7\u6c42")}}var para={url:"",project_key:"",retry_times:3,timeout_milliseconds:3e3,update_interval:6e5},info={scene:"",lib_version:"0.0.2",platform:"MiniProgram",storage_key:"sensorsdata2015_ABTest"},props={$manufacturer:"",$model:"",$os:"",$os_version:""},state={inited:!1,fetchInterval:null,test_list:null,trigger_list:[]};function mixinConfig(t){t.para=para,t.info=info,t.state=state,t.props=props}function mixinTrack(t){t.trackTestTrigger=function(e){var a=!1,r=!1;if(e.is_white_list)return!1;if(t.state.trigger_list.length>0&&(a=!0),-1!==t.state.trigger_list.indexOf(e.abtest_experiment_id)&&(r=!0),!r){var i={$abtest_experiment_id:e.abtest_experiment_id,$abtest_experiment_group_id:e.abtest_experiment_group_id};if(!a){var n="miniprogram_abtesting:"+t.info.lib_version;i.$lib_plugin_version=[n]}t.state.trigger_list.push(e.abtest_experiment_id),t._sa.track("$ABTestTrigger",i)}}}var ABTest={};mixinConfig(ABTest),mixinFetch(ABTest),initAPI(ABTest),mixinTrack(ABTest),ABTest.init=function(t,e){if(_.log("\u521d\u59cb\u5316 ABTest \u63d2\u4ef6"),this.state.inited)return!1;if(!this.setPara(e))return!1;if(this.state.inited=!0,this._sa=t,this.subId=new t.eventSub(this.handleIdChange),!this.state.test_list){var a=getStorageSync(this.info.storage_key);_.isObject(a)?this.state.test_list=a:this.state.test_list={}}_.getSystemInfo(this),this.subId.isReady(),this.listenAppLaunch()},ABTest.handleIdChange=function(t){"changeDistinctId"===t&&(ABTest.state.test_list={},setStorageSync(ABTest.info.storage_key,ABTest.state.test_list),ABTest.fetchTest())},ABTest.listenAppLaunch=function(){var t=wx.getLaunchOptionsSync();t&&t.scene&&(this.info.scene="wx-"+t.scene),this.fetchTest()};export default ABTest;